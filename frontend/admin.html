<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Team Voting System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1><i class="fas fa-vote-yea"></i> Team Voting System</h1>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="register.html" class="nav-link">Register</a>
                <a href="vote.html" class="nav-link">Vote</a>
                <a href="results.html" class="nav-link">Results</a>
                <a href="admin.html" class="nav-link active">Admin</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <!-- Admin Login -->
            <div id="admin-login" class="form-container">
                <h2><i class="fas fa-shield-alt"></i> Admin Login</h2>
                <div id="login-alerts"></div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="api-key" class="form-label">
                            <i class="fas fa-key"></i> Admin API Key
                        </label>
                        <input type="password" id="api-key" class="form-input" placeholder="Enter admin API key" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="hidden">
                <div class="hero-section" style="background: linear-gradient(135deg, var(--danger-color), #dc2626); margin-bottom: 2rem;">
                    <div class="hero-content">
                        <h1><i class="fas fa-cog"></i> Admin Panel</h1>
                        <p class="hero-description">Manage teams, members, and system settings</p>
                        <button id="logout-btn" class="btn btn-secondary">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>

                <div id="admin-alerts"></div>

                <!-- Quick Actions -->
                <div class="form-container">
                    <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                    <div class="features-grid">
                        <button id="generate-token-btn" class="btn btn-success feature-card" style="text-align: center;">
                            <i class="fas fa-plus"></i>
                            <h3>Generate Token</h3>
                            <p>Create registration token for new members</p>
                        </button>
                        <button id="show-teams-btn" class="btn btn-primary feature-card" style="text-align: center;">
                            <i class="fas fa-users"></i>
                            <h3>Manage Teams</h3>
                            <p>Create, edit, and delete teams</p>
                        </button>
                        <button id="show-members-btn" class="btn btn-warning feature-card" style="text-align: center;">
                            <i class="fas fa-user-friends"></i>
                            <h3>Manage Members</h3>
                            <p>View and manage member accounts</p>
                        </button>
                    </div>
                </div>

                <!-- Generated Token Display -->
                <div id="token-display" class="form-container hidden">
                    <h3><i class="fas fa-qrcode"></i> Generated Registration Token</h3>
                    <div class="alert alert-success">
                        <strong>Token:</strong> <code id="generated-token"></code>
                    </div>
                    <div class="alert alert-info">
                        <strong>Registration URL:</strong><br>
                        <code id="registration-url"></code>
                    </div>
                    <div class="mt-4">
                        <button id="copy-token" class="btn btn-secondary">
                            <i class="fas fa-copy"></i> Copy Token
                        </button>
                        <button id="copy-url" class="btn btn-secondary">
                            <i class="fas fa-link"></i> Copy URL
                        </button>
                        <button id="generate-qr" class="btn btn-outline">
                            <i class="fas fa-qrcode"></i> Show QR Code
                        </button>
                    </div>
                    <div id="qr-code" class="text-center mt-4 hidden"></div>
                </div>

                <!-- Teams Management -->
                <div id="teams-management" class="hidden">
                    <div class="form-container">
                        <h2><i class="fas fa-users"></i> Teams Management</h2>
                        
                        <!-- Add Team Form -->
                        <div class="mb-4">
                            <h3>Add New Team</h3>
                            <form id="add-team-form">
                                <div class="features-grid" style="grid-template-columns: 1fr 1fr auto;">
                                    <div class="form-group">
                                        <input type="text" id="team-name" class="form-input" placeholder="Team name" required>
                                    </div>
                                    <div class="form-group">
                                        <input type="url" id="team-avatar" class="form-input" placeholder="Avatar URL (optional)">
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus"></i> Add Team
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Teams List -->
                        <div id="teams-list">
                            <div class="loading">Loading teams...</div>
                        </div>
                    </div>
                </div>

                <!-- Members Management -->
                <div id="members-management" class="hidden">
                    <div class="form-container">
                        <h2><i class="fas fa-user-friends"></i> Members Management</h2>
                        
                        <!-- Add Member Form -->
                        <div class="mb-4">
                            <h3>Add New Member (Direct)</h3>
                            <form id="add-member-form">
                                <div class="features-grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
                                    <div class="form-group">
                                        <input type="text" id="member-name" class="form-input" placeholder="Full name" required>
                                    </div>
                                    <div class="form-group">
                                        <input type="text" id="member-username" class="form-input" placeholder="Username" required>
                                    </div>
                                    <div class="form-group">
                                        <input type="text" id="member-token" class="form-input" placeholder="Token" required>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-user-plus"></i> Add Member
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Members List -->
                        <div id="members-list">
                            <div class="loading">Loading members...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Team Voting System. Built with FastAPI and modern web technologies.</p>
        </div>
    </footer>

    <!-- Edit Modals -->
    <div id="edit-team-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Edit Team</h3>
            <form id="edit-team-form">
                <input type="hidden" id="edit-team-id">
                <div class="form-group">
                    <label class="form-label">Team Name</label>
                    <input type="text" id="edit-team-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Avatar URL</label>
                    <input type="url" id="edit-team-avatar" class="form-input">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-team-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-member-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Edit Member</h3>
            <form id="edit-member-form">
                <input type="hidden" id="edit-member-id">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="edit-member-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="edit-member-username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Token</label>
                    <input type="text" id="edit-member-token" class="form-input" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-member-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="https://cdn.qr-server.com/api/qr/js/qr.js"></script>
    <script>
        let adminApiKey = '';
        let teams = [];
        let members = [];

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Quick actions
            document.getElementById('generate-token-btn').addEventListener('click', generateToken);
            document.getElementById('show-teams-btn').addEventListener('click', showTeamsManagement);
            document.getElementById('show-members-btn').addEventListener('click', showMembersManagement);
            
            // Token actions
            document.getElementById('copy-token').addEventListener('click', copyToken);
            document.getElementById('copy-url').addEventListener('click', copyUrl);
            document.getElementById('generate-qr').addEventListener('click', generateQRCode);
            
            // Forms
            document.getElementById('add-team-form').addEventListener('submit', handleAddTeam);
            document.getElementById('add-member-form').addEventListener('submit', handleAddMember);
            document.getElementById('edit-team-form').addEventListener('submit', handleEditTeam);
            document.getElementById('edit-member-form').addEventListener('submit', handleEditMember);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!apiKey) {
                showAlert('login-alerts', 'Please enter the admin API key.', 'error');
                return;
            }

            try {
                // Test the API key by trying to get teams
                await api.getTeams(apiKey);
                adminApiKey = apiKey;
                showAdminPanel();
            } catch (error) {
                showAlert('login-alerts', 'Invalid API key. Please try again.', 'error');
            }
        }

        function handleLogout() {
            adminApiKey = '';
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
            document.getElementById('api-key').value = '';
            hideAllSections();
        }

        function showAdminPanel() {
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
        }

        function hideAllSections() {
            document.getElementById('token-display').classList.add('hidden');
            document.getElementById('teams-management').classList.add('hidden');
            document.getElementById('members-management').classList.add('hidden');
        }

        async function generateToken() {
            try {
                const token = await api.generateToken(adminApiKey);
                document.getElementById('generated-token').textContent = token;
                document.getElementById('registration-url').textContent = 
                    `${window.location.origin}/register.html?token=${token}`;
                document.getElementById('token-display').classList.remove('hidden');
                showAlert('admin-alerts', 'Registration token generated successfully!', 'success');
            } catch (error) {
                showAlert('admin-alerts', 'Failed to generate token.', 'error');
            }
        }

        function copyToken() {
            const token = document.getElementById('generated-token').textContent;
            navigator.clipboard.writeText(token).then(() => {
                showAlert('admin-alerts', 'Token copied to clipboard!', 'success');
            });
        }

        function copyUrl() {
            const url = document.getElementById('registration-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                showAlert('admin-alerts', 'Registration URL copied to clipboard!', 'success');
            });
        }

        function generateQRCode() {
            const url = document.getElementById('registration-url').textContent;
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = `
                <h4>QR Code for Registration</h4>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}" alt="Registration QR Code">
                <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray-500);">
                    Scan this QR code to open the registration page with the token pre-filled.
                </p>
            `;
            qrContainer.classList.remove('hidden');
        }

        async function showTeamsManagement() {
            hideAllSections();
            document.getElementById('teams-management').classList.remove('hidden');
            await loadTeams();
        }

        async function showMembersManagement() {
            hideAllSections();
            document.getElementById('members-management').classList.remove('hidden');
            await loadMembers();
        }

        async function loadTeams() {
            try {
                teams = await api.getTeams();
                renderTeamsList();
            } catch (error) {
                document.getElementById('teams-list').innerHTML = 
                    '<div class="alert alert-error">Failed to load teams.</div>';
            }
        }

        function renderTeamsList() {
            const container = document.getElementById('teams-list');
            
            if (teams.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No teams found.</div>';
                return;
            }

            container.innerHTML = `
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: var(--gray-100);">
                                <th style="padding: 1rem; text-align: left;">ID</th>
                                <th style="padding: 1rem; text-align: left;">Name</th>
                                <th style="padding: 1rem; text-align: left;">Avatar</th>
                                <th style="padding: 1rem; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teams.map(team => `
                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                    <td style="padding: 1rem;">${team.id}</td>
                                    <td style="padding: 1rem; font-weight: 600;">${team.name}</td>
                                    <td style="padding: 1rem;">
                                        ${team.avatar ? `<img src="${team.avatar}" alt="Avatar" style="width: 30px; height: 30px; border-radius: 50%;">` : 'None'}
                                    </td>
                                    <td style="padding: 1rem; text-align: center;">
                                        <button onclick="editTeam(${team.id})" class="btn btn-outline" style="margin-right: 0.5rem;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteTeam(${team.id})" class="btn btn-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function loadMembers() {
            try {
                members = await api.getMembers(adminApiKey);
                renderMembersList();
            } catch (error) {
                document.getElementById('members-list').innerHTML = 
                    '<div class="alert alert-error">Failed to load members.</div>';
            }
        }

        function renderMembersList() {
            const container = document.getElementById('members-list');
            
            if (members.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No members found.</div>';
                return;
            }

            container.innerHTML = `
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: var(--gray-100);">
                                <th style="padding: 1rem; text-align: left;">ID</th>
                                <th style="padding: 1rem; text-align: left;">Name</th>
                                <th style="padding: 1rem; text-align: left;">Username</th>
                                <th style="padding: 1rem; text-align: center;">Team</th>
                                <th style="padding: 1rem; text-align: center;">Voted</th>
                                <th style="padding: 1rem; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${members.map(member => `
                                <tr style="border-bottom: 1px solid var(--gray-200);">
                                    <td style="padding: 1rem;">${member.id}</td>
                                    <td style="padding: 1rem; font-weight: 600;">${member.name}</td>
                                    <td style="padding: 1rem;">${member.username}</td>
                                    <td style="padding: 1rem; text-align: center;">
                                        ${member.has_joined_team ? 'Yes' : 'No'}
                                    </td>
                                    <td style="padding: 1rem; text-align: center;">
                                        ${member.has_voted ? 'Yes' : 'No'}
                                    </td>
                                    <td style="padding: 1rem; text-align: center;">
                                        <button onclick="editMember(${member.id})" class="btn btn-outline" style="margin-right: 0.5rem;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteMember(${member.id})" class="btn btn-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Team operations
        async function handleAddTeam(e) {
            e.preventDefault();
            const name = document.getElementById('team-name').value.trim();
            const avatar = document.getElementById('team-avatar').value.trim() || null;

            try {
                await api.createTeam({ name, avatar }, adminApiKey);
                showAlert('admin-alerts', 'Team created successfully!', 'success');
                document.getElementById('add-team-form').reset();
                await loadTeams();
            } catch (error) {
                showAlert('admin-alerts', 'Failed to create team.', 'error');
            }
        }

        function editTeam(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;

            document.getElementById('edit-team-id').value = team.id;
            document.getElementById('edit-team-name').value = team.name;
            document.getElementById('edit-team-avatar').value = team.avatar || '';
            showModal('edit-team-modal');
        }

        async function handleEditTeam(e) {
            e.preventDefault();
            const id = document.getElementById('edit-team-id').value;
            const name = document.getElementById('edit-team-name').value.trim();
            const avatar = document.getElementById('edit-team-avatar').value.trim() || null;

            try {
                await api.updateTeam(id, { name, avatar }, adminApiKey);
                showAlert('admin-alerts', 'Team updated successfully!', 'success');
                closeModal('edit-team-modal');
                await loadTeams();
            } catch (error) {
                showAlert('admin-alerts', 'Failed to update team.', 'error');
            }
        }

        async function deleteTeam(teamId) {
            if (confirm('Are you sure you want to delete this team? This will remove all associated data.')) {
                try {
                    await api.deleteTeam(teamId, adminApiKey);
                    showAlert('admin-alerts', 'Team deleted successfully!', 'success');
                    await loadTeams();
                } catch (error) {
                    showAlert('admin-alerts', 'Failed to delete team.', 'error');
                }
            }
        }

        // Member operations
        async function handleAddMember(e) {
            e.preventDefault();
            const name = document.getElementById('member-name').value.trim();
            const username = document.getElementById('member-username').value.trim();
            const token = document.getElementById('member-token').value.trim();

            try {
                await api.createMember({ name, username, token, has_joined_team: false }, adminApiKey);
                showAlert('admin-alerts', 'Member created successfully!', 'success');
                document.getElementById('add-member-form').reset();
                await loadMembers();
            } catch (error) {
                showAlert('admin-alerts', 'Failed to create member.', 'error');
            }
        }

        function editMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            document.getElementById('edit-member-id').value = member.id;
            document.getElementById('edit-member-name').value = member.name;
            document.getElementById('edit-member-username').value = member.username;
            document.getElementById('edit-member-token').value = member.token;
            showModal('edit-member-modal');
        }

        async function handleEditMember(e) {
            e.preventDefault();
            const id = document.getElementById('edit-member-id').value;
            const name = document.getElementById('edit-member-name').value.trim();
            const username = document.getElementById('edit-member-username').value.trim();
            const token = document.getElementById('edit-member-token').value.trim();

            try {
                await api.updateMember(id, { name, username, token }, adminApiKey);
                showAlert('admin-alerts', 'Member updated successfully!', 'success');
                closeModal('edit-member-modal');
                await loadMembers();
            } catch (error) {
                showAlert('admin-alerts', 'Failed to update member.', 'error');
            }
        }

        async function deleteMember(memberId) {
            if (confirm('Are you sure you want to delete this member? This will remove all their data.')) {
                try {
                    await api.deleteMember(memberId, adminApiKey);
                    showAlert('admin-alerts', 'Member deleted successfully!', 'success');
                    await loadMembers();
                } catch (error) {
                    showAlert('admin-alerts', 'Failed to delete member.', 'error');
                }
            }
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</body>
</html>